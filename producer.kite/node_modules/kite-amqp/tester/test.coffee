assert = require 'assert'
puts = console.log
amqp = require 'amqp'
connection = amqp.createConnection url: 'amqp://localhost'

recvCount = 0
body = JSON.stringify {
  method: 'foo'
  withArgs: {}
  secretChannelId: 'rabbitrabbit'
  callbackId: '0'
}
connection.addListener "ready", ->
  puts "connected to " + connection.serverProperties.product
  connection.exchange "kite-dummyamqpkite-exchange",
    type        : "topic"
    autoDelete  : yes
    durable     : yes
  , (exchange) ->
    connection.queue "kite-dummyamqpkite-request", (q) ->
      q.bind exchange, "#"
      q.on "queueBindOk", ->
        q.on "basicConsumeOk", ->
          puts "publishing message"
          connection.queue '', exclusive: yes, (replyQueue)->
            exchange.publish "message.text", body,
              contentType: "text/plain"
              replyTo: replyQueue.name
            
            replyQueue.subscribe (message, headers, deliveryInfo)->
              console.log 'Got a response', message.data+''


        q.subscribeRaw (m) ->
          puts "--- Message (" + m.deliveryTag + ", '" + m.routingKey + "') ---"
          puts "--- contentType: " + m.contentType
          recvCount++
          assert.equal "text/plain", m.contentType
          size = 0
          m.addListener "data", (d) ->
            puts d+''
            size += d.length

          m.addListener "end", ->
            assert.equal body.length, size
            m.acknowledge()






process.addListener "exit", ->
  assert.equal 1, recvCount
